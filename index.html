<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pizza client</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <style>
      body { margin: 15px; }
      div.tab-pane { margin: 10px; }
      #toppings {
        padding: 5px;
        margin: 5px;
      }
      #toppings span {
        padding: 5px;
        margin: 10px;
      }
      #pizzas .card {
        margin: 10px;
      }
      footer {
        text-align: center;
      }
    </style>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"  crossorigin="anonymous"></script>
    <script>
      var _pizzaClient = function(url, config) {
        if (config === undefined) {
          this.config = {
            container: 'pizzaClient',
            endpoints: {
              toppings: '/toppings',
              pizzas: '/pizzas',
              pizzatoppings: '/pizzas/%ID%/toppings',
            }
          }
        } else {
          this.config = config;
        };
        this.base_url = url;
        this.toppings = $('#toppings');
        this.pizzas = $('#pissaz');
        this.availableToppings = {};
        this.availablePizzas = {};
      };
      _pizzaClient.prototype = {
        // formatted endpoint url.
        'url': function(endpoint, id) {
          if (endpoint === undefined) {
            return this.base_url;
          }
          var url = this.base_url + this.config.endpoints[endpoint];
          if (id === undefined) {
            return url;
          }
          return url.replace(/%ID%/, id);
        },
        'addToppingCb': function(data) {
           var item = $('<option>').attr({'value': data.id}).text(data.name);
           this.toppings.append(item);
           this.updateToppings();
        },
        // returns an Array of toppings
        'addTopping': function(evt) {
          var input = $("#topping");
          var data = {'topping': {'name': input.val()}};
          input.val('');
          $.post(this.url('toppings'), data, this.addToppingCb.bind(this));
        },
        'addPizzaCb': function(data) {
          var pizzas = $("#pizzas");
          var lastRow = pizzas.find('div.row:last');
          if (lastRow.length === 0) {
            lastRow = $('<div>').addClass('row');
            pizzas.append(lastRow);
          }
          if (lastRow.find('div[name=pizza]').length < 2) {
            lastRow.append(this.renderPizza(data));
          } else {
            lastRow = $('<div>').addClass('row');
            lastRow.append(this.renderPizza(data));
            pizzas.append(lastRow);
          }
          if (this.availablePizzas[data.id] === undefined) {
            this.availablePizzas[data.id] = {
              'id': data.id,
              'name': data.name,
              'description': data.description,
              'toppings': {},
            };
          }
        },
        'addPizza': function() {
          var name = $("#pizza").val();
          var description = $("#pizza-description").val();
          var data = {'pizza': {'name': name, 'description': description}};
          $.post(this.url('pizzas'), data, this.addPizzaCb.bind(this));
          $("#pizza").val('');
          $("#pizza-description").val('');

        },
        'addPizzaTopping': function(evt) {
          var pizza_id = evt.data.id;
          var availableToppings = [];
          var pizzaToppingIds = [];
          $.each(this.availableToppings, function(id, data) {
            availableToppings.push(data);
          });
          $.each(this.availablePizzas[pizza_id]['toppings'], function(id, data) {
              pizzaToppingIds.push(data.topping_id);
          });
          var availableToppings = availableToppings.filter(function(x) {
            // true when the available topping is not already a pizza topping
            return pizzaToppingIds.indexOf(x.id) == -1;
          });
          var addPizzaToppingsDiv = $('#addPizzaToppings');
          var toppings = addPizzaToppingsDiv.find('select[name=availableToppings]');
          toppings.html('');
          $(availableToppings).each(function(idx, data) {
            var id = data.topping_id;
            // TODO: Check this
            if (id === undefined) {
              id = data.id;
            }
            var option = $('<option>').attr({'data-topping-id': id}).text(data.name);
            toppings.append(option);
          });
          addPizzaToppingsDiv.find('button[name=add-pizza-topping]').click(
            evt.data, this.addPizzaToppingSubmit.bind(this)
          );
          addPizzaToppingsDiv.modal('show');
        },
        'addPizzaToppingCb': function(data) {
          if (Object.keys(data.errors).length > 0) {
            console.log(data.errors)
            return;
          }
          var pizza_id = data.object.pizza_id;
          var pizzaDiv = $("div[data-pizza-id=" + pizza_id + "]");
          // TODO: Only re-render the updated pizza
          this.updatePizzas();
        },
        'addPizzaToppingSubmit': function(evt) {
          var pizza = evt.data;
          var toppingSelect = $('#addPizzaToppings').find("select[name=availableToppings] option:selected");
          var id = toppingSelect.attr('data-topping-id');
          var post_data = {'topping_id': id};
          var url = this.url('pizzatoppings', pizza.id);
          $("#addPizzaToppings").modal('hide');
          $.post(url, post_data, this.addPizzaToppingCb.bind(this));
        },
        'updatePizzaToppings': function(id, div) {
          if (div === undefined) {
            var div = $('[data-pizza-id='+id+']').find('div.pizza-toppings');
          }
          $.get(this.url('pizzatoppings', id), function(data) {
            var pizza = this.availablePizzas[id];
            $(data).each(function(idx, topping) {
              var span = $('<span>').addClass('badge badge-primary').html(topping.name);
              div.append([span, ' ']);
              if (pizza.toppings[topping.topping_id] === undefined) {
                pizza.toppings[topping.topping_id] = topping;
              }
            }.bind(this));
            //console.log(data);
          }.bind(this));
        },
        // returns an Array of pizzas
        'listPizzas': function(url) {
          this.url = url
        },
        'togglePizzaInfo': function() {
          console.log('togglePizzaInfo');
          $(this).find('div.panel-body').toggle();
        },
        // Handle successful toppins enpoint response
        'updateToppingsCb': function(data) {
          var toppings = $("#toppings");
          // Remove existing toppings
          toppings.html("");
          // Re-populate toppings list
          $(data).each(function(idx, topping) {
            var item = $('<div>').attr({
              'topping-id': topping.id,
              'class': 'badge badge-primary'
            }).text(topping.name);
            // Adding a space required for proper line wrapping.
            toppings.append([item, ' ']);
            if (this.availableToppings[topping.id] === undefined) {
              this.availableToppings[topping.id] = topping;
            }
          }.bind(this));
        },
        // Update the available toppings
        'updateToppings': function(callback) {
          $.get(this.url('toppings'), this.updateToppingsCb.bind(this));
        },
        // Handle successful pizzas enpoint response
        'updatePizzasCb': function(data) {
          var pizzas = $("#pizzas");
          pizzas.html("");
          var renderPizza = this.renderPizza.bind(this);
          $(data).each(function(idx, pizza) {
            var lastRow = pizzas.find('div.row:last');
            if (lastRow.length === 0) {
              lastRow = $('<div>').addClass('row');
              pizzas.append(lastRow);
            }
            if (lastRow.find('div[name=pizza]').length < 2) {
              lastRow.append(renderPizza(pizza));
            } else {
              lastRow = $('<div>').addClass('row');
              lastRow.append(renderPizza(pizza));
              pizzas.append(lastRow);
            }
            if (this.availablePizzas[pizza.id] === undefined) {
              this.availablePizzas[pizza.id] = {
                'id': pizza.id,
                'name': pizza.name,
                'description': pizza.description,
                'toppings': {},
              };
            }
          }.bind(this));
        },
        'updatePizzas': function(callback) {
          if (callback === undefined) {
            $.get(this.url('pizzas'), this.updatePizzasCb.bind(this));
          } else {
            var updateCb = function(data) {
                this.updatePizzasCb(data);
                callback(data);
            };
            $.get(this.url('pizzas'), updateCb.bind(this));
          }
        },
        'renderPizza': function(data) {
          var div = $('#templates').find('div[name=pizza]').clone();
          div.attr({'data-pizza-id': data.id});
          var a = div.find('[name=name]').html(data.name);
          a.click(this.togglePizzaInfo.bind(div));
          div.find('span[name=description]').text(data.description);
          this.updatePizzaToppings(data.id, div.find('.pizza-toppings'));
          div.find('span[name=add-pizza-topping]').click(data, this.addPizzaTopping.bind(this));
          return div;
        }
      };
      function pizzaClient(url) {
        return new _pizzaClient(url);
      };
      /*
       * Create a new pizza client pointing to the pizza server
       */
      p = pizzaClient('http://192.168.99.100:3000');
      $(document).ready(function() {
        $('#add-topping').click(p.addTopping.bind(p));
        $('#add-pizza').click(p.addPizza.bind(p));
        p.updateToppings();
        p.updatePizzas();
      });
      var client_info = {
        "client_name": "Trusona Pizza Client - Daniel Wozniak",
        "client_id": "",
        "client_secret": "",
        "subject_type": "pairwise",
        "client_secret_expires_at": 0,
        "callback_url": "http://trusona-pizza-client.woz.io",
        "authorization_url": "https://idp.trusona.com/authorizations/openid",
        "token_validation_url": "https://idp.trusona.com/openid/token",
        "response_type": "id_token token",
        "scope": "openid profile email",
      }
      generateState = function() {
        var crypto = window.crypto || window.msCrypto;
        var buf = new Uint8Array(8);
        var k = ''
        crypto.getRandomValues(buf);
        for (var x = 0; x < 8; x ++) {
          k += ("00" + buf[x]).slice(-2);
        };
        return k;
      };
      authorizationUrl = function() {
        var state = arguments[0] || '';
        var nonce = arguments[1] || '';
        var url= client_info.authorization_url + '?' +
          'client_id=' + encodeURIComponent(client_info.client_id) + '&' +
          'redirect_uri=' + encodeURIComponent(client_info.callback_url) + '&' +
          'response_type=' + encodeURIComponent(client_info.response_type) + '&' +
          'scope=' + encodeURIComponent(client_info.scope);
        if (nonce != '') {
          url += '&nonce=' + nonce;
        }
        if (state != '') {
          url += '&state=' + state;
        }
        /* This is implied by our oidc provider at the moment.
        if( performSilently ) {
          url = url + "&prompt=none";
        }
        */
        return url;
      };
    </script>
  </head>
  <body>
    <header>
      <h1>Pizza Client</h1>
    </header>
    <div id="pizzaClient" class="container-fluid">
      <ul class="nav nav-tabs">
        <li class="nav-item"><a href="#pizzas-tab" data-toggle="tab" class="nav-link active">Pizzas</a></li>
        <li class="nav-item"><a href="#toppings-tab" data-toggle="tab" class="nav-link">Toppings</a></li>
      </ul>
      <div class="tab-content clearfix">
        <div id="pizzas-tab" class="tab-pane active">
          <div id="pizzas" class="container-fluid">
          </div>
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-4">
                <input id="pizza" class="form-control col" placeholder="Name" class="width:50%" />
              </div>
              <div class="col-sm-6">
                <input id="pizza-description" class="form-control col" placeholder="Description"  class="width:50%"/>
              </div>
              <div class="col-sm-2">
                <button id="add-pizza" class="btn btn-default" type="button">Add</button>
              </div>
            </div>
          </div>
        </div>
        <div id="toppings-tab" class="tab-pane container-fluid">
          <div id="toppings" class="container-fluid">
          </div>
          <div class="input-group">
            <input id="topping" class="form-control" placeholder="Add a topping..." />
            <span class="input-group-btn">
              <button id="add-topping" class="btn btn-default" type="button">Add</button>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div id="templates" style="display:none">
      <!-- Pizza card -->
      <div name="pizza" class="card" style="width: 20rem">
        <div class="card-header">
         <h5 name="name" class="card-title"></h5>
        </div>
        <div class="card-body">
          <b>Description</b>
          <div class="card-sub-title">
            <span name="description"></span>
          </div>
          <b>Toppings <span name="add-pizza-topping" class="fa fa-plus" aria-hidden="true"></span></b>
          <div class="pizza-toppings card-text">
          </div>
        </div>
      </div>
   </div>
    <div id="addPizzaToppings" name="addPizzaToppings" class="modal fade">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add a Pizza Topping</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Select the topping you would like to add</p>
            <div class="input-group">
              <select name="availableToppings" class="form-control selectpicker" data-live-search="true">
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button name="add-pizza-topping" type="button" class="btn btn-primary">Add Topping</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <footer>
      &#9400; 2017 Pizza Cient
    </footer>
  </body>
</html>
