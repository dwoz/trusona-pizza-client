<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pizza client</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <style>
      body { margin: 15px; }
      div.tab-pane { margin: 10px; }
      #toppings {
        padding: 5px;
        margin: 5px;
      }
      #toppings span {
        padding: 5px;
        margin: 10;
      }
    </style>
    <script
      src="//code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"  crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
    <script>
      var _pizzaClient = function(url, config) {
        if (config === undefined) {
          this.config = {
            container: 'pizzaClient',
            endpoints: {
              toppings: '/toppings',
              pizzas: '/pizzas',
              pizzatoppings: '/pizzas/%ID%/toppings',
            }
          }
        } else {
          this.config = config;
        };
        this.base_url = url;
        this.toppings = $('#toppings');
        this.pizzas = $('#pissaz');
      };
      _pizzaClient.prototype = {
        // formatted endpoint url.
        'url': function(endpoint, id) {
          if (endpoint === undefined) {
            return this.base_url;
          }
          var url = this.base_url + this.config.endpoints[endpoint];
          if (id === undefined) {
            return url;
          }
          return url.replace(/%ID%/, id);
        },
        // returns an Array of toppings
        'addTopping': function(name, callback) {
          var data = {'topping': {'name': name}};
          var client = this;
          if (callback !== undefined) {
            callback = callback.bind(this);
          };
          $.post(
            this.url('toppings'),
            data,
            function(data) {
              var item = $('<option>').attr({'value': data.id}).text(data.name);
              client.toppings.append(item);
              if (callback !== undefined) {
                callback(data);
              };
            }
          );
        },
        'addPizzaCb': function(data) {
          var pizzas = $("#pizzas");
          pizzas.append(this.renderPizza(data));
        },
        'addPizza': function(name, description, callback) {
          var data = {'pizza': {'name': name, 'description': description}};
          var client = this;
          $.post(this.url('pizzas'), data, this.addPizzaCb.bind(this));
        },
        'updatePizzaToppings': function(id, div) {
          if (div === undefined) {
            var div = $('[data-pizza-id='+id+']').find('div.pizza-toppings');
          }
          $.get(this.url('pizzatoppings', id), function(data) {
            $(data).each(function(idx, topping) {
              var span = $('<span>').html(topping.name);
              div.append([span, ' ']);
            });
            console.log(data);
          });
        },
        // returns an Array of pizzas
        'listPizzas': function(url) {
          this.url = url
        },
        'togglePizzaInfo': function() {
          console.log('togglePizzaInfo');
          $(this).find('div.panel-body').toggle();
        },
        // Handle successful toppins enpoint response
        'updateToppingsCb': function(data) {
          var toppings = $("#toppings");
          // Remove existing toppings
          toppings.html("");
          // Re-populate toppings list
          $(data).each(function(idx, topping) {
            var item = $('<div>').attr({
              'topping-id': topping.id,
              'class': 'label label-primary'
            }).text(topping.name);
            // Adding a space required for proper line wrapping.
            toppings.append([item, ' ']);
          });
        },
        // Update the available toppings
        'updateToppings': function(callback) {
          $.get(this.url('toppings'), this.updateToppingsCb);
        },
        // Handle successful pizzas enpoint response
        'updatePizzasCb': function(data) {
          var pizzas = $("#pizzas");
          pizzas.html("");
          var renderPizza = this.renderPizza.bind(this);
          $(data).each(function(idx, pizza) {
            pizzas.append(renderPizza(pizza));
          });
        },
        'updatePizzas': function(callback) {
          $.get(this.url('pizzas'), this.updatePizzasCb.bind(this));
        },
        'renderPizza': function(data) {
          var div = $('#templates').find('div[name=pizza]').clone();
          div.attr({'data-pizza-id': data.id});
          var a = div.find('[name=name]').html(data.name);
          a.click(this.togglePizzaInfo.bind(div));
          div.find('span[name=description]').text(data.description);
          this.updatePizzaToppings(data.id, div.find('.pizza-toppings'));
          return div;
        }
      };
      function pizzaClient(url) {
        return new _pizzaClient(url);
      };
      p = pizzaClient('http://192.168.99.100:3000');
      $(document).ready(function() {
        $('#add-topping').click(function() {
          var input = $("#topping");
          p.addTopping(input.val(), p.updateToppings);
        });
        $('#add-pizza').click(function() {
          var input = $("#pizza");
          p.addPizza($('#pizza').val(), $('#pizza-description').val());
        });
        $('#pizzas').each(function(idx, div) {
          $(div).find('a[name=name]').click(p.togglePizzaInfo.bind(div));
        });
        p.updateToppings();
        p.updatePizzas();
        // $(".btn").click(function(){
            $("#pizzaToppingsModal").modal('show');
         // });
      });
    </script>
  </head>
  <body>
    <header>
      <h1>Pizza Client</h1>
    </header>
    <div id="pizzaClient" class="containr-fluid">
      <ul class="nav nav-tabs">
        <li class="nav-item"><a href="#pizzas-tab" data-toggle="tab" class="nav-link active">Pizzas</a></li>
        <li class="nav-item"><a href="#toppings-tab" data-toggle="tab" class="nav-link">Toppings</a></li>
      </ul>
      <div class="tab-content clearfix">
        <div id="pizzas-tab" class="tab-pane active">
          <div id="pizzas" class="container-fluid">
          </div>
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-4">
                <input id="pizza" class="form-control col" placeholder="Name" class="width:50%" />
              </div>
              <div class="col-sm-6">
                <input id="pizza-description" class="form-control col" placeholder="Description"  class="width:50%"/>
              </div>
              <div class="col-sm-2">
                <button id="add-pizza" class="btn btn-default" type="button">Add</button>
              </div>
            </div>
          </div>
        </div>
        <div id="toppings-tab" class="tab-pane container-fluid">
          <div id="toppings" class="container-fluid"></div>
          <div class="input-group">
            <input id="topping" class="form-control" placeholder="Add a topping..." />
            <span class="input-group-btn">
              <button id="add-topping" class="btn btn-default" type="button">Add</button>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div id="templates" style="display:none">
			<!-- Pizza card -->
      <div name="pizza" class="card" style="width: 20rem">
        <div class="card-header">
         <h5 name="name" class="card-title"></h5>
        </div>
        <div class="card-body">
          <b>Description</b>
          <div class="card-sub-title">
            <span name="description"></span>
          </div>
          <b>Toppings <span class="fa fa-plus" aria-hidden="true"></span></b>
          <div class="pizza-toppings card-text">
          </div>
        </div>
      </div>
      <!-- Add pizza topping modal -->
      <div class="modal fade" id="pizzaToppingsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            <div class="input-group">
              <select class="form-control selectpicker" data-live-search="true">
              </select>
              <span class="input-group-btn">
                <button id="add-pizza-topping" class="btn btn-default" type="button">Add</button>
              </span>
            </div>
              ...
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
